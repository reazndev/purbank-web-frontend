<div class="transaction-container">
  <div class="transaction-header">
    <div class="header-row">
      <h2>{{ translations().completedTransactions }}</h2>
    </div>
    <hr>
  </div>
  
  <div *ngIf="isLoading" class="loading">{{ translations().loading }}</div>
  <div *ngIf="error" class="error-message">{{ error }}</div>

  <div class="transactions-grid scrollable-grid" *ngIf="!isLoading && groupedTransactions.length > 0">
    <ng-container *ngFor="let group of groupedTransactions">
      <div class="date-header">{{ languageService.formatDate(group.date) }}</div>
      <div class="transaction-box" *ngFor="let transaction of group.transactions">
        <span class="transaction-name">{{ (transaction.transactionType === 'INTEREST' ? '' : (transaction.message || transaction.iban)) || transaction.message }}</span>
        <span class="transaction-balance" [class.negative]="transaction.transactionType === 'OUTGOING'" [class.positive]="transaction.transactionType === 'INCOMING' || transaction.transactionType === 'INTEREST'">
          {{ transaction.transactionType === 'OUTGOING' ? '-' : '+' }}{{ MathAbs(transaction.amount) | number:'1.2-2' }} {{ transaction.currency }}
        </span>
        <div class="transaction-actions">
            <button class="info-btn" (click)="showTransactionDetail(transaction)" [title]="translations().viewDetails">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-info"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
            </button>
            <button class="info-btn" (click)="editTransaction(transaction)" [title]="translations().editTransaction">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
            </button>
        </div>
      </div>
    </ng-container>
  </div>

  <div *ngIf="!isLoading && groupedTransactions.length === 0" class="empty-state">
    {{ translations().noTransactionData }}
  </div>
</div>

<!-- Details Modal -->
<div class="modal-overlay" *ngIf="showDetailModal && selectedTransaction" (click)="closeDetailModal()">
  <div class="detail-modal-content" (click)="$event.stopPropagation()">
    <div class="detail-header">
      <h2>{{ translations().transactionDetails }}</h2>
      <button class="icon-btn" (click)="closeDetailModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
      </button>
    </div>
    <hr>
    
    <!-- View Mode -->
    <div class="detail-content" *ngIf="!isEditing">
      <div class="detail-row">
        <span class="detail-label">{{ translations().message }}:</span>
        <span class="detail-value">{{ selectedTransaction.message }}</span>
      </div>
      <div class="detail-row" *ngIf="selectedTransaction.transactionType === 'INCOMING'">
        <span class="detail-label">{{ translations().accountFrom }}:</span>
        <span class="detail-value">{{ selectedTransaction.iban }}</span>
      </div>
      <div class="detail-row" *ngIf="selectedTransaction.transactionType === 'OUTGOING'">
        <span class="detail-label">{{ translations().accountTo }}:</span>
        <span class="detail-value">{{ selectedTransaction.iban }}</span>
      </div>
      <div class="detail-row" *ngIf="selectedTransaction.transactionType === 'INTEREST'">
        <span class="detail-label">{{ translations().accountTo }}:</span>
        <span class="detail-value">{{ selectedTransaction.iban }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">{{ translations().amount }}:</span>
        <span class="detail-value" [class.positive]="selectedTransaction.transactionType === 'INCOMING' || selectedTransaction.transactionType === 'INTEREST'" [class.negative]="selectedTransaction.transactionType === 'OUTGOING'">
          {{ selectedTransaction.transactionType === 'OUTGOING' ? '-' : '+' }}{{ MathAbs(selectedTransaction.amount) | number:'1.2-2' }} {{ selectedTransaction.currency }}
        </span>
      </div>
      <div class="detail-row">
        <span class="detail-label">{{ translations().executionType }}:</span>
        <span class="detail-value">{{ selectedTransaction.executionType || 'INSTANT' }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">{{ translations().executionDate }}:</span>
        <span class="detail-value">{{ selectedTransaction.timestamp | date:'medium' }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">{{ translations().locked }}:</span>
        <span class="detail-value">{{ selectedTransaction.locked ? translations().yes : translations().no }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">{{ translations().note }}:</span>
        <span class="detail-value">{{ selectedTransaction.note || '-' }}</span>
      </div>
      
      <div class="detail-actions">
        <button class="edit-action-btn" (click)="startEdit()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
            {{ translations().editTransaction }}
        </button>
        <button class="delete-btn" (click)="deleteTransaction()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
            {{ translations().deletePayment }}
        </button>
      </div>
    </div>

    <!-- Edit Mode -->
    <div class="edit-form" *ngIf="isEditing">
      <div class="form-group">
        <label>{{ translations().message }}</label>
        <input [(ngModel)]="editForm.message">
      </div>
      <div class="form-group">
        <label>{{ translations().iban }}</label>
        <input [(ngModel)]="editForm.iban">
      </div>
      <div class="form-group">
        <label>{{ translations().amount }}</label>
        <input type="number" [(ngModel)]="editForm.amount">
      </div>
      <div class="form-group">
        <label>{{ translations().transactionType || 'Type' }}</label>
        <select [(ngModel)]="editForm.transactionType">
            <option value="INCOMING">INCOMING</option>
            <option value="OUTGOING">OUTGOING</option>
        </select>
      </div>
      <div class="form-group">
        <label>{{ translations().note }}</label>
        <textarea [(ngModel)]="editForm.note" rows="3"></textarea>
      </div>
      
      <div class="modal-actions">
        <button class="btn-cancel" (click)="cancelEdit()">{{ translations().cancel }}</button>
        <button class="btn-primary" (click)="saveTransaction()">{{ translations().apply }}</button>
      </div>
    </div>
  </div>
</div>
