<div class="transaction-container" *ngIf="!alwaysExpanded">
  <div class="transaction-header">
    <div class="header-row">
      <h2>
        {{ onlyOutgoing ? languageService.translate('completedPayments') : languageService.translate('completedTransactions') }}
      </h2>
      <button class="icon-btn" (click)="toggleExpand()">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-expand"><path d="m15 15 6 6"></path><path d="m15 9 6-6"></path><path d="M21 16v5h-5"></path><path d="M21 8V3h-5"></path><path d="M3 16v5h5"></path><path d="m3 21 6-6"></path><path d="M3 8V3h5"></path><path d="M9 9 3 3"></path></svg>
      </button>
    </div>
    <hr>
  </div>
  <div class="transactions-grid scrollable-grid">
    <ng-container *ngFor="let group of groupedTransactions">
      <div class="date-header">{{ languageService.formatDate(group.date) }}</div>
      <div class="transaction-box" *ngFor="let transaction of group.transactions">
        <span class="transaction-name">{{ transaction.name }}</span>
        <span class="transaction-balance">
          {{ transaction.amount > 0 ? '' : '- ' }}{{ MathAbs(transaction.amount) }} {{ transaction.currency }}
        </span>
        <button class="info-btn" (click)="showTransactionDetail(transaction)" [title]="languageService.translate('viewDetails')">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-info"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
        </button>
      </div>
    </ng-container>
  </div>
  <div class="scroll-indicator">
    {{ languageService.translate('scrollForMore') }}
  </div>
</div>

<div class="modal-overlay" *ngIf="isExpanded && !alwaysExpanded" (click)="toggleExpand()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <ng-container *ngTemplateOutlet="expandedContent"></ng-container>
  </div>
</div>

<div class="transaction-container full-width" *ngIf="alwaysExpanded">
    <ng-container *ngTemplateOutlet="expandedContent"></ng-container>
</div>

<ng-template #expandedContent>
    <div class="transaction-header">
        <div class="header-row">
          <h2>
            {{ onlyOutgoing ? languageService.translate('completedPayments') : languageService.translate('completedTransactions') }}
          </h2>
          <button class="icon-btn" (click)="toggleExpand()" *ngIf="!alwaysExpanded">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-minimize-2"><path d="m14 10 7-7"></path><path d="M20 10h-6V4"></path><path d="m3 21 7-7"></path><path d="M4 14h6v6"></path></svg>
          </button>
        </div>
        <hr>
      </div>
      <div class="transactions-grid full-height-grid">
        <div class="transaction-header-row">
          <span class="transaction-label">{{ languageService.translate('message') }}</span>
          <span class="transaction-label">{{ languageService.translate('iban') }}</span>
          <span class="transaction-label">{{ languageService.translate('note') }}</span>
          <span class="transaction-label">{{ languageService.translate('amount') }}</span>
        </div>
        <ng-container *ngFor="let group of groupedTransactions">
          <div class="date-header">{{ languageService.formatDate(group.date) }}</div>
          <div class="transaction-box-expanded" *ngFor="let transaction of group.transactions">
            <span class="transaction-value">{{ transaction.name }}</span>
            <span class="transaction-value">{{ transaction.transactionType === 'INTEREST' ? '-' : transaction.otherPartyIban }}</span>
            <span class="transaction-value">{{ transaction.note || '-' }}</span>
            <span class="transaction-balance">
              {{ transaction.amount > 0 ? '' : '- ' }}{{ MathAbs(transaction.amount) }} {{ transaction.currency }}
            </span>
            <button class="info-btn" (click)="showTransactionDetail(transaction)" [title]="languageService.translate('viewDetails')">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-info"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
            </button>
          </div>
        </ng-container>
      </div>
</ng-template>

<div class="modal-overlay" *ngIf="showDetailModal" (click)="closeDetailModal()">
  <div class="detail-modal-content" (click)="$event.stopPropagation()">
    <div class="detail-header">
      <h2>{{ selectedTransaction?.name }}</h2>
      <button class="icon-btn" (click)="closeDetailModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>
      </button>
    </div>
    <hr>
    <div class="detail-content" *ngIf="selectedTransaction">
      <div class="detail-row" *ngIf="selectedTransaction.transactionType !== 'INTEREST'">
        <span class="detail-label">{{ languageService.translate('account') }}:</span>
        <span class="detail-value">{{ selectedTransaction.account }}</span>
      </div>
      <div class="detail-row" *ngIf="selectedTransaction.transactionType === 'INCOMING'">
        <span class="detail-label">{{ languageService.translate('fromIban') }}:</span>
        <span class="detail-value">{{ selectedTransaction.otherPartyIban }}</span>
      </div>
      <div class="detail-row" *ngIf="selectedTransaction.transactionType === 'OUTGOING'">
        <span class="detail-label">{{ languageService.translate('toIban') }}:</span>
        <span class="detail-value">{{ selectedTransaction.otherPartyIban }}</span>
      </div>
      <div class="detail-row" *ngIf="selectedTransaction.transactionType === 'INTEREST'">
        <span class="detail-label">{{ languageService.translate('toIban') }}:</span>
        <span class="detail-value">{{ selectedTransaction.account }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">{{ languageService.translate('amount') }}:</span>
        <span class="detail-value" [class.positive]="selectedTransaction.amount > 0" [class.negative]="selectedTransaction.amount < 0">
          {{ selectedTransaction.amount > 0 ? '+' : '' }}{{ selectedTransaction.amount }} {{ selectedTransaction.currency }}
        </span>
      </div>
      <div class="detail-row">
        <span class="detail-label">{{ languageService.translate('message') }}:</span>
        <span class="detail-value">{{ selectedTransaction.name }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">{{ languageService.translate('note') }}:</span>
        <span class="detail-value">{{ selectedTransaction.note || '-' }}</span>
      </div>
    </div>
    <div class="detail-actions">
        <button class="edit-action-btn" (click)="startEditNote(selectedTransaction)" *ngIf="editingTransactionId !== selectedTransaction.transactionId">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square-pen"><path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z"></path></svg>
            {{ languageService.translate('editNote') }}
        </button>
        <div class="edit-note-container" *ngIf="editingTransactionId === selectedTransaction.transactionId">
            <input type="text" [(ngModel)]="editNoteValue" (keydown.enter)="saveNote(selectedTransaction)" (keydown.escape)="cancelEditNote()" autofocus>
            <div class="edit-actions">
                <button class="action-btn-small save" (click)="saveNote(selectedTransaction)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check"><polyline points="20 6 9 17 4 12"></polyline></svg>
                </button>
                <button class="action-btn-small cancel" (click)="cancelEditNote()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
        </div>
    </div>
  </div>
</div>
